# Pulsar 项目 OTA 功能设计与实现文档 (MCU2)

**日期**：2026.01.23
**适用模块**：Pulsar - MCU2 (SmartWebServer / WiFi模块)

---

## 1. 概述

本项目旨在为 Pulsar 板载的 MCU2 (ESP32-PICO-MINI-02U) 实现基于 Web 的 OTA (Over-The-Air) 固件升级功能。该功能允许用户通过 WiFi 连接MCU2的设备热点，在浏览器端直接上传编译好的 .bin 文件完成固件更新，无需拆机连接 USB 线或使用编程器。

## 2. 技术实现方案

### 2.1 核心架构：Native A/B 分区切换

本方案采用 ESP32 原生的 OTA 机制，利用 Flash 的双 App 分区（A/B Partition）实现无缝升级。

- **分区策略**：
    
    - 采用 **"Minimal SPIFFS (1.9MB APP with OTA)"** 分区表。
        
    - **原理**：Flash 被划分为 App0 (当前运行)、App1 (备份/升级目标) 和 SPIFFS (文件系统)。
        
    - **流程**：系统运行时接收新固件 -> 写入非活动分区（如 App1） -> 校验完整性 -> 修改 Bootloader 引导指针 -> 重启切换至新分区。
        

### 2.2 软件栈

- **基础库**：ArduinoOTA / Update.h (ESP32 Core自带的标准库)。
    
- **Web 服务**：集成于OnStepX项目现有的 SmartWebServer，新增 /update 路由节点。
    
- **前端实现**：纯 HTML/JS 实现，包含文件选择器和基于 XMLHttpRequest 的上传进度条。
    

### 2.3 交互流程

1. 用户给Pulsar通上电，Pulsar正常启动（出现热点）
2. 用户连接 Pulsar WiFi 热点。
3. 浏览器访问 http://192.168.0.1/update.htm。
4. 上传 .bin 固件文件。
5. 后端流式写入 Flash，完成后自动重启。


---

## 3. 方案评估 (Pros & Cons)

### 3.1 优点 (Pros)

1. **用户体验友好**：无需安装任何驱动或上位机软件，手机/平板/电脑均可操作，符合 Pulsar 作为天文设备的野外使用场景。
    
2. **高可靠性 (Anti-Brick)**：
    
    - **原子性操作**：只有当固件完整写入且 MD5 校验通过后，才会切换启动分区。
        
    - **回滚机制 (Rollback)**：如果新固件写入中断或校验失败，系统仍会从旧分区启动，极大降低了“变砖”风险。
        
3. **开发成本低**：基于 ESP32 成熟的生态库实现，代码侵入性小，与现有 WebServer 兼容性好。
    
4. **无外网依赖**：采用 Local AP 模式（局域网），不需要连接互联网云服务器，适合野外无网环境。
    

### 3.2 缺点与局限性 (Cons)

1. **存储空间牺牲**：
    
    - 为了支持 A/B 分区，必须预留两倍的固件空间（App0 + App1）。这导致可用的 **SPIFFS（文件系统）空间被严重压缩**，可能限制未来网页资源的扩展（如星图数据库）。
    - 但是就目前来看，空间是足够的，单个MCU都有 8MB SPI FLASH，而当前版本实现了通过Web进行OTA的版本，其编译后的.bin文件大小只有约1.0MB
        
2. **缺乏版本控制与校验**：
    
    - 目前方案未实现复杂的版本号检查。用户可能会误刷入旧版本固件，甚至误刷入其他 ESP32 项目的固件（只要格式合法），导致逻辑错误。
        
3. **WiFi 稳定性依赖**：
    
    - ESP32的WiFi使用2.4Ghz通道，在居民楼等WiFi环境复杂或者通道拥挤的地方，其WiFi稳定性可能下降。OTA 过程完全依赖无线信号。如果在写入过程中 WiFi 受到严重干扰断开，虽然不会变砖，但会导致升级失败，需要用户重试。
        
4. **安全性考量**：
    
    - 目前的 /update 接口在局域网内是开放的，没有强制的鉴权机制（如 Token 或密码），尽管WiFi密码可以更改，但是连接到 WiFi 的任何人都可以尝试刷写固件，存在风险。
        

---

## 4. 风险控制与应对

|                         |                                                  |
| ----------------------- | ------------------------------------------------ |
| 风险点                     | 应对措施                                             |
| **固件过大导致溢出**            | 编译时严格监控 .bin 大小，确保不超过 1.9MB 分区限制。                |
| **升级后无法启动 (Boot Loop)** | 利用 ESP32 的看门狗机制，若新固件多次启动失败，Bootloader 会自动回滚至旧分区。 |
| **误操作刷错文件**             | 前端增加简单的文件名/扩展名校验；后端依靠 Update 库的 Magic Byte 校验。   |

---

## 5. 后续规划 (Next Steps)

当前实现的仅为 **MCU2 (WiFi模块)** 的自身升级。Pulsar 系统中更核心的 **MCU1 (电机控制/OnStepX)** 尚未实现 OTA。

**下一阶段挑战**：  
实现 **MCU2 代理升级 MCU1**。

- **原理**：用户上传 MCU1 固件到 MCU2 -> MCU2 通过串口 (UART) 将固件透传给 MCU1 -> 控制 MCU1 进入 Boot 模式并写入。
    
- **难点**：涉及双芯片间的串口协议协调、GPIO 复位时序控制以及流控稳定性。